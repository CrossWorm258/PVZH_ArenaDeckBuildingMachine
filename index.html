<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <style>
       /* å®šä¹‰å¡ç‰‡çš„æ ·å¼ */
      .cards {
        width: 150px;
        height: 100px;
        background-color: white;
        position: absolute;
        top: 200px;
        text-align: center
      }
      /* å®šä¹‰å¡ç‰‡çš„æ ·å¼ */
      #main {
        width: 600px;
        height: 400px;
        background-color: white;
        /* margin: 0 auto; */
        /* position: absolute */
      }
      /* å®šä¹‰é€‰æ‹©åŒºçš„æ ·å¼ */
      #chose {
        width: 600px;
        height: 1500px;
        background-color: dimgray;
        color: white;
      }
      #c1 {
        left: 0px
      }
      #c2 {
        left: 225px
      }
      #c3 {
        left: 450px
      }
      /* å®šä¹‰å¡ç‰‡çš„æ ·å¼ */
      .card {
        border-radius: 10px;
        padding: 5px;
        background-color: grey;
      }
      /* å®šä¹‰å¡ç‰‡å†…éƒ¨çš„æ ·å¼ */
      .card-in{
        border-radius: 10px;
        background-color: #663DA2;
        width: 100%;
        height: 100%;
        position: relative;
        text-align: center;
      }
      /* å®šä¹‰å¡ç‰‡å†…éƒ¨æ–‡å­—çš„æ ·å¼ */
      .card-in div{
        background-repeat: no-repeat;
        text-align: center;
        position: absolute;
        color: grey;
        bottom: 5px;
      }
      
    </style>
  </head>
  <body>
    <div id="main">
      <div class="cards" id="c1" onclick="choose(this.id)">
        
      </div>
      <div class="cards" id="c2" onclick="choose(this.id)">

      </div>
      <div class="cards" id="c3" onclick="choose(this.id)">
        
      </div>
      
    </div>

    <!-- é€‰æ‹©åŒº -->
    <div id="chose">

    </div>

    




    <script src="cards.js"></script>
    <!-- <script src="temp.js"></script> -->
    <script src="translation.js"></script>
    <script src="costs.js"></script>
    <script>
      
      // åˆå§‹åŒ–è´¹ç”¨å¡ç‰Œæ•°é‡æ•°ç»„
      var costCurDeck = Array(12).fill(0); // è´¹ç”¨æœ€å¤§ä¸º11

      var nowArr = []; // å½“å‰é€‰ä¸­çš„å¡ç‰‡æ•°ç»„
      var mainAttr; // ä¸»è¦å±æ€§ï¼Œç”¨æˆ·é€‰æ‹©çš„å±æ€§å€¼
      var choseObj = {}; // å­˜å‚¨å·²é€‰æ‹©çš„å¡ç‰‡åŠå…¶æ•°é‡çš„å¯¹è±¡
      var cardsnum = 0; // å½“å‰æ€»å…±é€‰æ‹©çš„å¡ç‰‡æ•°é‡
      var cards10 = 0; // å½“å‰é€‰æ‹©çš„å¡ç‰‡æ˜¯å¦æ»¡è¶³10å¼ çš„æ¡ä»¶è®¡æ•°å™¨
      var specialt = false; // æ˜¯å¦å¤„äºç‰¹æ®ŠæŠ½å¡çŠ¶æ€çš„æ ‡å¿—
      const heroes = {
        "åšæœ": [5, 6],
        "é¦™æ©¼": [5, 7],
        "èåœ": [5, 7],
        "ç™½èœ": [5, 8],
        "åœŸè±†": [5, 9],
        "ç«ç‘°": [6, 7],
        "å¤§å˜´": [6, 8],
        "è€€æ–‘": [6, 9],
        "ç»¿å½±": [7, 8],
        "æš—å¤œ": [7, 9],
        "ç«æ ‘": [8, 9],

        "è¶…å°¸": [0, 1],
        "å¤§ç‹": [0, 1],
        "å¥³å¦–": [0, 2],
        "æ•™æˆ": [0, 3],
        "é”ˆé“": [0, 4],
        "é›ªäºº": [1, 2],
        "æ— ç©·": [1, 3],
        "æµ·å¦–": [1, 4],
        "èˆç‹": [2, 3],
        "æ‘”è·¤": [2, 4],
        "æœºç”²": [3, 4],
      }
      var heroesc = false;

      // å¾ªç¯ç›´åˆ°ç”¨æˆ·è¾“å…¥æœ‰æ•ˆçš„è‹±é›„å±æ€§
      while (!heroesc) {
        let opt = prompt("è¯·è¾“å…¥ä½ çš„è‹±é›„ï¼š\nåšæœ é¦™æ©¼ èåœ ç™½èœ åœŸè±† ç«ç‘° å¤§å˜´ è€€æ–‘ ç»¿å½± æš—å¤œ ç«æ ‘\nè¶…å°¸ å¤§ç‹ å¥³å¦– æ•™æˆ é”ˆé“ é›ªäºº æ— ç©· æµ·å¦– èˆç‹ æ‘”è·¤ æœºç”²");
        if (heroes[opt] != undefined) {
          mainAttr = heroes[opt];
          heroesc = true;
        } else {
          alert("ğŸ˜¡");
        }
      }

      // è·å–æŒ‡å®šidçš„DOMå…ƒç´ 
      function G(id) {
        return document.getElementById(id);
      }
      
      // è°ƒæ•´å½“å‰æ˜¾ç¤ºçš„ä¸‰å¼ å¡ç‰‡
      function adjust() {
        if (cardsnum == 40) {
          return alert("å®Œæˆé€‰ç‰Œ");
        }

        let t1 = generate();
        let t2 = generate();
        let t3 = generate();
        while (t1.name == t3.name) {
          t1 = generate();
        }
        while (t1.name == t2.name || t3.name == t2.name) {
          t2 = generate();
        }

        if (specialt) {
          specialt = false;
        }

        nowArr.push(t1);
        nowArr.push(t2);
        nowArr.push(t3);
      }


      function generate() {

        let p = Math.random();
        let r;
        // ç‰¹æ®ŠæŠ“å¡æƒ…å†µ
        if (specialt) {
          console.log("ç‰¹æ®ŠæŠ“å¡æ•°é‡ï¼š" + cardsnum);
          if (cards10 % 2 == 0) {
            r = 3;
          }
          else {
            r = Math.random() < 0.5 ? 2 : 5;
          }
          // nowsl = false;
        } else {
          if (p <= 0.05) r = 3;  // ä¼ è¯´
          else if (p <= 0.11) r = 2;  // è¶…ç¨€æœ‰
          else if (p <= 0.17) r = 5;  // æ´»åŠ¨
          else if (p <= 0.34) r = 1;  // ç¨€æœ‰
          else if (p <= 0.85) r = 0;  // ç½•è§
          else r = 4;  // æ™®é€š
        }

        // ç”Ÿæˆå¡ç‰‡è´¹ç”¨èŒƒå›´
        let costset;
        
        if (specialt) {
          costset = [0, 11];// ç‰¹æ®ŠæŠ“å¡çš„è´¹ç”¨èŒƒå›´æ˜¯ [0, 10]todo
        } else {
          let q = Math.random();
          if (q <= 0.30) costset = [0, 2];
          else if (q <= 0.60) costset = [3, 4];
          else if (q <= 0.85) costset = [5, 6];
          else costset = [7, 11];
        }
        
        // `find` å‡½æ•°ç”¨äºæ ¹æ®ç¨€æœ‰åº¦ã€ä¸»å±æ€§å’Œè´¹ç”¨èŒƒå›´æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å¡ç‰‡åç§°çš„æ•°ç»„ carr
        let carr = find(r, mainAttr, costset);
        if (!carr.length) return generate(); // å¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å¡ç‰Œï¼Œåˆ™é‡æ–°ç”Ÿæˆ

        // éšæœºç”Ÿæˆä¸€ä¸ªç´¢å¼•
        let rnd = Math.floor(Math.random() * carr.length); 
        let name = carr[rnd];

        // å¦‚æœå·²é€‰æ‹©çš„å¡ç‰‡æ•°é‡è¾¾åˆ° 4ï¼Œåˆ™é‡æ–°ç”Ÿæˆ
        if (choseObj[name] != undefined && choseObj[name] == 4) return generate();
        
        let cardobj = { name: name, num: r === 3 ? 1 : Math.floor(Math.random() * 2 + 1) };
        if (cardobj.num + cardsnum > 40) return generate();

        if (choseObj[name] != undefined && choseObj[name] + cardobj.num > 4) return generate();


        
        return cardobj;
      }

      adjust();
      anal();
      output();
    
      function output() {
        G("chose").innerHTML = "";
        G("chose").innerHTML += ('<div style="font-size: 20px; font-weight: bold;">å…±' + cardsnum + '/40å¼ </div>');

        let choseArr = Object.keys(choseObj).sort((a, b) => {
          return costs[a] - costs[b];
        });

        for (let i = 0;i < choseArr.length; i++) {
          let opt = choseArr[i];
          G("chose").innerHTML += (choseObj[opt] + "å¼ " + " - " + costs[opt] + 'è´¹' + " - " + translation[opt] + "<br>");
        }
        G("chose").innerHTML +=("<br><br>");
        updateCardInfo(); // åœ¨å¾ªç¯ä¹‹åæ›´æ–°å¡ç‰Œä¿¡æ¯
      }


      // æ›´æ–°å·²é€‰æ‹©çš„å¡ç‰Œä¿¡æ¯
      function updateCardInfo() {

          // è®¡ç®—å¹¶å±•ç¤ºè´¹ç”¨0-7å’Œ8+çš„å¡ç‰Œæ•°é‡
          let cardCounts = costCurDeck.slice(0, 8); // è´¹ç”¨0-7çš„å¡ç‰Œæ•°é‡
          let cardCount8Plus = costCurDeck.slice(8).reduce((acc, cur) => acc + cur, 0); // è´¹ç”¨8+çš„å¡ç‰Œæ•°é‡

          // ç”Ÿæˆå±•ç¤ºå­—ç¬¦ä¸²
          let cardInfo = "";

          // å·¦ä¾§è´¹ç”¨å±•ç¤º
          for (let i = 0; i <= 7; i++) {
              cardInfo += `${i}è´¹   : ${cardCounts[i]}<br>`;
          }
          cardInfo += `8è´¹+: ${cardCount8Plus}<br>`;

          // æ›´æ–°å®¹å™¨å†…å®¹
          G("chose").innerHTML += cardInfo;
      }



      function choose(id) {
        // ä»idä¸­æå–ç´¢å¼•å€¼ (æœ€åä¸€ä¸ªå­—ç¬¦)ï¼Œç”¨äºè¯†åˆ«å½“å‰ç‚¹å‡»çš„æ˜¯å“ªå¼ ç‰Œ
        let index = parseInt(id.charAt(id.length - 1));
        let tobj = nowArr[index - 1];// æ ¹æ®ç´¢å¼•è·å–å½“å‰é€‰ä¸­çš„ç‰Œå¯¹è±¡
        // æ›´æ–°é€‰æ‹©å¯¹è±¡çš„æ•°é‡ï¼Œå¦‚æœè¯¥å¡ç‰‡å·²ç»è¢«é€‰æ‹©è¿‡åˆ™å¢åŠ æ•°é‡
        if (choseObj[tobj.name] != undefined) {
          choseObj[tobj.name] += tobj.num;
        } else {
          choseObj[tobj.name] = tobj.num;
        }

        // æ›´æ–°è´¹ç”¨å¡ç‰Œæ•°é‡æ•°ç»„
        costCurDeck[costs[tobj.name]] += tobj.num;


        // æ¸…ç©º
        G("c1").innerHTML = "";
        G("c2").innerHTML = "";
        G("c3").innerHTML = "";
        nowArr = [];

        cardsnum += tobj.num;
        if (Math.floor((cardsnum + 1) / 10) != cards10) {
          cards10 += 1;
          specialt = true;
        }
        
        adjust();
        anal();
        output();
      }
      
      //å±•ç¤ºä¸‰é€‰ä¸€å¡ç‰‡å›¾ç‰‡å’Œä¿¡æ¯
      function anal() {
        if (cardsnum == 40) {
          return;
        }
        for (let i = 0; i < 3; i++) {
          let name = nowArr[i].name;
          createcard(name, i + 1);
          G("c" + (i + 1)).innerHTML += (translation[name] + "Ã—" + nowArr[i].num + "<br>" + costs[name] +"è´¹");
          
        }
      }

      //todo:é“ƒé“›11è´¹
      function find(rarity, carr, cst = [0, 11]) {
        var xrr = [];
        for (let j = 0; j < 2; j++) {
          
          let color = cards[colors[carr[j]]];
          let arrl = color.length;
          for (let i = 0; i < arrl; i++) {
            let obj = color[i];
            if (obj.rarity == rarity) {
              if (costs[obj.name] >= cst[0] && costs[obj.name] <= cst[1]) {
                xrr.push(obj.name);
              }
            }
          }
        }
        return xrr;
      }

      function createcard(name, num) {
        let card = document.createElement("div");
        card.className = "card";
        card.style.width = "140px";
        card.style.height = "100px";

        let cin = document.createElement("div");
        cin.className = "card-in";
        cin.style["font-size"] = "20px";

        let img = document.createElement("img");
        img.src = "images/" + name + ".png";
        img.style["object-fit"] = "cover";
        img.style["object-position"] = "50% 20%";
        img.style.width = "130px";
        img.style.height = "90px";
        cin.appendChild(img);
        card.appendChild(cin);
        G("c" + num).append(card);
      }



      //-------

      function echo(c) {
        let color = cards[colors[c]];
        color.forEach(obj => {
          console.log(obj.name + ":" + translation[obj.name]);
        });
      }
      
      function extract(){
        for (let i = 0; i < 10; i++) {
          let cards = [];
          // let xrr = ;
          for (let x in xrr) {
            let xard = xrr[x];
            if (xard.color != colors[i]) {
              continue;
            }
            if (xard.set == "Superpower" || xard.set == "Token") {
              continue;
            }
            let tempc = {
              name: xard.prefabName,
              rarity: xard.rarity
            };
            kosts[xard.prefabName] = xard.displaySunCost,
            cards.push(tempc);
          }
          kards[colors[i]] = cards;
        }
      }

    </script>
  </body>
</html>